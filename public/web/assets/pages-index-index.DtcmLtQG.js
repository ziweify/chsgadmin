import{g as t,a as s,n as e,p as a,s as l,c as o,o as i,b as n,r as c,d as r,e as u,f as d,h as p,i as h,j as g,w as m,k as f,l as b,m as w,q as y,F as v,t as k,u as _,S as x,I as S,v as T,x as j,y as I,z as O,A as F}from"./index-DOJCnOSq.js";import{_ as M,c as H}from"./_plugin-vue_export-helper.NqDkV_r6.js";const J=M({data:()=>({inputValue:"",list:[],image:"",scrollHeight:0,baseUrl:"",bottomTarget:"chat-11",timer:0}),computed:{windowObj(){let s;return t({success:t=>{s=t}}),s}},mounted(){s("user")?(this.baseUrl=H.image_host,this.connectSocket()):e({url:"/pages/login/login"})},methods:{loadMores(){},tapTo(t){switch(t){case 1:this.image="https://nimg.ws.126.net/?url=http%3A%2F%2Fdingyue.ws.126.net%2F2021%2F0826%2F6def4faej00qygdfw009kd200u001hcg00u001hc.jpg&thumbnail=660x2147483647&quality=80&type=jpg",this.newsSend(2);break;case 2:this.newsSend(1);break;case 3:let t=[];this.list.forEach(((s,e)=>{2===s.type&&t.push(s.content)})),a({urls:t,css:"background-position: center;background-size:contain;"})}},getInput(t){this.inputValue=t.detail.value},newsSend(t){var s={type:"chat",chat_type:"text",content:this.inputValue};l({data:JSON.stringify(s),complete:t=>{this.inputValue=""}}),this.setScrollTop()},initChatLog(){this.list=[]},toBottom(){setTimeout((()=>{this.bottomTarget="chat-"+(this.list.length-1)}))},connectSocket(){let t=this;t.data,t.userInfo;let e=s("user");o({url:H.ws_host+`?username=${e.username}&password=${s("password")}`}),i((function(s){t.timer=setInterval((()=>{l({data:JSON.stringify({type:"ping"})}),console.log("ping")}),5e3)})),n((function(e){var a=JSON.parse(e.data);let o=s("user");switch(a.type){case"init":l({data:JSON.stringify({type:"bind",fromid:2}),complete:t=>{}});break;case"text":a.isMe=!1,a.type=a.message_type,t.list=t.list.concat([a]),t.setScrollTop();break;case"chatList":a.data.forEach((s=>{let e=JSON.parse(s);e.isMe=e.sender.id==o.id,e.avatar=t.baseUrl+"/"+e.sender.avatar,t.list=[...t.list,e]})),t.toBottom();break;case"chatOne":console.log(a),a.data.isMe=a.data.sender.id==o.id,a.data.avatar=t.baseUrl+"/"+a.data.sender.avatar,t.list=[...t.list,a.data],t.toBottom();break;case"logout":c("user"),c("password"),clearInterval(t.timer),r({success(){console.log("websocket正常退出")}}),u({title:"登陆异常",content:a.msg,showCancel:!1,success({confirm:t}){t&&d({url:"/pages/login/login"})}})}}))},setScrollTop(){this.$nextTick((()=>{p().select(".scroll-view").fields({size:!0},(t=>{let s=t.height;this.scrollHeight=s})).exec()}))}}},[["render",function(t,s,e,a,l,o){const i=O,n=f,c=F,r=x,u=S;return h(),g(n,{class:""},{default:m((()=>[b(r,{"scroll-y":"true",class:"scroll-box",style:k({height:o.windowObj.windowHeight-o.windowObj.statusBarHeight-94+"px"}),"scroll-top":l.scrollHeight,onScrolltoupper:o.loadMores,"scroll-into-view":l.bottomTarget,"scroll-with-animation":!0},{default:m((()=>[b(n,{class:"scroll-view"},{default:m((()=>[(h(!0),w(v,null,y(l.list,((t,s)=>(h(),g(n,{class:"news-box",key:s},{default:m((()=>[b(i,{class:T(["avatar",[t.isMe?"is-me":"avatar-right"]]),src:t.avatar,mode:"aspectFill"},null,8,["class","src"]),b(n,{class:T(["message-box",{"is-me":t.isMe}])},{default:m((()=>[b(n,{class:"nickname"},{default:m((()=>[_(j(t.sender.nickname),1)])),_:2},1024),2!==t.type?(h(),g(c,{key:0,class:"message"},{default:m((()=>[_(j(t.content||""),1)])),_:2},1024)):I("",!0)])),_:2},1032,["class"]),b(n,{id:`chat-${s}`},null,8,["id"])])),_:2},1024)))),128))])),_:1})])),_:1},8,["style","scroll-top","onScrolltoupper","scroll-into-view"]),b(n,{class:"base-btn"},{default:m((()=>[b(n,{class:"base-con unify-flex"},{default:m((()=>[b(u,{class:"input-text",type:"text",style:{flex:"1"},value:l.inputValue,placeholder:"说些什么吧",onInput:o.getInput,onConfirm:s[0]||(s[0]=t=>o.tapTo(2))},null,8,["value","onInput"]),b(n,{class:"send-input",onClick:s[1]||(s[1]=t=>o.tapTo(2))},{default:m((()=>[_("发送")])),_:1})])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-b6943526"]]);export{J as default};
